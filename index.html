<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ROM ‚Äî Make My Day (AI Twin)</title>
<meta name="description" content="ROM-style minimal planner with Privacy Center, Twin Memory, explainable AI, connectors, and timeboxing." />
<style>
:root{
  --bg:#F6F7FB; --surface:#FFFFFF; --surface-2:#F2F5FA;
  --ink:#0B1220; --muted:#667085; --stroke:#E7EAF2;
  --accent:#0A84FF; --success:#34C759; --violet:#AF52DE;
  --danger:#EF4444; --orange:#F59E0B; --blue:#3B82F6; --green:#22C55E;
  --radius-xl:26px; --radius:18px; --max:1060px;
  --fs-xs:clamp(11px,2.4vw,12px);
  --fs-s: clamp(13px,2.6vw,14px);
  --fs-m: clamp(15px,3.2vw,16px);
  --fs-l: clamp(22px,4.8vw,28px);
  --fs-xl:clamp(26px,6.2vw,34px);
  --shadow-lg: 0 28px 60px rgba(16,24,40,.10), 0 10px 20px rgba(16,24,40,.06);
}
*{box-sizing:border-box}
html,body{height:100%}
html{background:var(--bg); color:var(--ink); -webkit-text-size-adjust:100%}
body{margin:0; font:450 16px/1.5 ui-rounded, system-ui, -apple-system, "SF Pro Rounded","SF Pro Text","Segoe UI",Roboto,Helvetica,Arial}
.app{min-height:100%; display:flex; flex-direction:column; align-items:center; gap:16px; padding:18px 0 calc(112px + env(safe-area-inset-bottom));}
.content{width:100%; max-width:var(--max); padding:0 20px 10px;}
.section{margin-top:6px}
.h1{font-weight:800; letter-spacing:-.01em; font-size:var(--fs-xl); margin:0 0 14px}
.card{background:var(--surface); border-radius:var(--radius-xl); box-shadow:var(--shadow-lg); padding:18px}
.top-actions{display:flex; gap:10px; justify-content:flex-end; align-items:center; margin-top:4px}
.icon-btn{appearance:none; border:1px solid var(--stroke); background:#fff; border-radius:12px; padding:8px 10px; cursor:pointer}
.icon-btn span{font-size:12px; color:#374151; margin-left:8px}
.badge-mode{font-size:11px; padding:2px 8px; border-radius:999px; background:#ecfeff; border:1px solid #bae6fd; color:#075985}
small,.small{font-size:var(--fs-s); color:#8A90A2}
textarea{width:100%; min-height:128px; resize:vertical; border:1px solid var(--stroke); border-radius:18px; background:linear-gradient(180deg,#fff,#fbfcff); padding:14px; font-size:var(--fs-m); color:#111827}
.recall{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
.chip{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--stroke); background:#fff; border-radius:999px; padding:6px 10px; font-size:12px}
.chip .btn-mini{margin-left:4px; border:1px solid #d1fae5; background:#ecfdf5; color:#166534; border-radius:999px; padding:2px 6px; font-weight:700; cursor:pointer}
.btns{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
.btn{appearance:none; cursor:pointer; padding:10px 16px; border-radius:14px; border:1px solid var(--stroke); background:#fff; color:#1F2937; font-weight:650; font-size:var(--fs-s); box-shadow:0 1px 0 rgba(255,255,255,.7) inset, 0 1px 0 rgba(0,0,0,.03); transition:transform .05s ease, filter .15s ease}
.btn:active{transform:translateY(1px)}
.btn.primary{background:linear-gradient(180deg,#46D86F,#2FBE58); color:#fff; border-color:#2FBE58}
.btn.tint-blue{background:linear-gradient(180deg,#EAF2FF,#E6F0FF); border-color:#D6E6FF; color:#0B4A9A}
.btn.tint-purple{background:linear-gradient(180deg,#F2E9FB,#F6EEFE); border-color:#E6D9FA; color:#6D28D9}
.btn.danger{background:linear-gradient(180deg,#FFF1F2,#FFE7EA); border-color:#FFD3D7; color:#B91C1C}
.btn.ghost{background:#fff}
.assist{display:grid; gap:12px}
.suggestion{display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; border:1px solid var(--stroke); background:#fff; border-radius:14px; padding:10px 12px}
.tag{font-size:11px; font-weight:750; padding:4px 8px; border-radius:999px; color:#0b1220; background:#eef2ff; border:1px solid #dbe3ff}
.tag.orange{background:#fff7ed; border-color:#ffe4d5}
.tag.green{background:#ecfdf5; border-color:#d1fae5}
.source{font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; color:#374151; background:#fff}
.actions{display:flex; gap:6px}
.btn-xxs{font-size:11px; padding:6px 8px; border-radius:10px; border:1px solid var(--stroke); background:#fff; cursor:pointer}
.explain{grid-column:1 / -1; font-size:12px; color:#6b7280; display:none; padding-left:6px}
.outcome{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:6px}
.out-pill{display:inline-flex; gap:6px; align-items:center; padding:8px 12px; border-radius:999px; border:1px solid var(--stroke); background:#fff; font-size:12px}
.score{font-weight:800}
.deck{display:grid; gap:18px; grid-template-columns:1fr}
@media(min-width:720px){ .deck{grid-template-columns:repeat(3,1fr)} }
.card-focus{border-radius:22px; overflow:hidden; background:#fff; min-height:206px; box-shadow:var(--shadow-lg); display:flex; flex-direction:column}
.focus-head{display:flex; align-items:center; justify-content:space-between; padding:14px 18px 10px; background:linear-gradient(180deg,#FFF7D6 0,#FFFBEA 100%); border-bottom:1px solid #F3E7B2}
.focus-title{margin:0; font-size:18px; font-weight:780; letter-spacing:-.01em}
.badge{font-size:12px; color:#fff; padding:4px 8px; border-radius:999px}
.badge.green{background:#22c55e}.badge.orange{background:#f59e0b}.badge.blue{background:#3b82f6}
.focus-body{padding:12px 18px 8px 16px; flex:1}
.tasks{list-style:none; margin:0; padding:0}
.taskli{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:6px 6px 6px 8px; border-radius:10px; cursor:pointer}
.taskli:hover{background:#f7f8fb}
.taskli .txt{flex:1}
.taskli.done .txt{opacity:.55; text-decoration:line-through}
.mini-done{min-width:30px; height:28px; border-radius:10px; border:1px solid #CDEBD7; background:#F1F8F4; color:#166534; font-weight:700; cursor:pointer}
.focus-foot{display:flex; align-items:center; justify-content:flex-end; gap:8px; padding:10px 12px; border-top:1px solid var(--stroke); background:#FCFDFE}
.tick{display:inline-flex; align-items:center; gap:8px; background:#F1F8F4; border:1px solid #CDEBD7; color:#166534; padding:8px 12px; border-radius:12px; font-size:var(--fs-s); font-weight:650; cursor:pointer}
.card-focus button.plain{border:none; background:transparent; color:#374151; font-weight:600; cursor:pointer}
.footer{position:fixed; left:0; right:0; bottom:0; z-index:10; background:rgba(255,255,255,.92); backdrop-filter:saturate(180%) blur(16px); border-top:1px solid var(--stroke); padding:12px 12px calc(10px + env(safe-area-inset-bottom)); display:flex; justify-content:center; gap:10px;}
.soon-btn{appearance:none; border:1px solid #D1D5DB; background:linear-gradient(180deg,#F8FAFC,#EEF2F7); color:#111827; padding:12px 18px; border-radius:14px; font-weight:750; letter-spacing:.2px; cursor:pointer}
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:18px; background:rgba(2,6,23,.46); backdrop-filter:blur(8px); z-index:20}
.modal.open{display:flex}
.modal-card{max-width:820px}
.form-row{display:grid; grid-template-columns:140px 1fr; gap:10px; align-items:center; margin:8px 0}
input[type="text"], input[type="datetime-local"], textarea.modal-input{width:100%; border:1px solid var(--stroke); border-radius:12px; padding:10px; font-size:var(--fs-m); background:#fff}
.label{color:#4b5563; font-size:var(--fs-s)}
.snack{position:fixed; left:50%; transform:translateX(-50%); bottom:86px; background:#111827; color:#fff; padding:10px 14px; border-radius:12px; display:none; gap:12px; align-items:center; z-index:30}
.snack.show{display:flex}
.snack button{border:1px solid #374151; background:#1f2937; color:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; font-size:12px}
</style>
</head>
<body>
<div class="app">
  <main class="content" role="main">

    <div class="top-actions">
      <span class="badge-mode" id="modeBadge">Local-only</span>
      <button class="icon-btn" id="memoryBtn" title="Memory Inspector">üß†<span>Memory</span></button>
      <button class="icon-btn" id="privacyBtn" title="Privacy Center">üõ°Ô∏è<span>Privacy</span></button>
    </div>

    <!-- Day in a Life -->
    <section class="section">
      <h1 class="h1">Day in a Life</h1>
      <div class="card">
        <p class="small">Brain-dump your tasks, plans, and wishes ‚Äî one per line or separated by commas.</p>
        <textarea id="dayInput" placeholder="e.g. Finish deck; email Michelle about advisor call; gym; plan Europe trip; buy groceries"></textarea>
        <div id="recallChips" class="recall" aria-live="polite"></div>
        <div class="btns">
          <button class="btn ghost"  id="demoBtn">Demo</button>
          <button class="btn danger" id="clearBtn">Clear</button>
          <button class="btn primary" id="makeBtn">Make My Day Simple</button>
          <button class="btn tint-blue" id="timeboxBtn" title="Draft a simple schedule">Timebox My Day</button>
          <button class="btn" id="pasteEmailBtn" title="Analyze a pasted email">Analyze Email</button>
        </div>
        <div class="btns" style="margin-top:8px">
          <button class="btn tint-blue"   id="waterBtn">Drink Water</button>
          <button class="btn tint-purple" id="focusBtn">Focus 25m</button>
          <span class="small" id="focusStatus"></span>
        </div>
      </div>
    </section>

    <!-- AI Assist -->
    <section class="section">
      <h2 class="h1" style="font-size:var(--fs-l)">AI Assist</h2>
      <div class="card">
        <div class="assist" id="assistList"></div>
        <div class="btns">
          <button class="btn ghost" id="refreshAssist">Refresh Suggestions</button>
          <button class="btn primary" id="addSelected">Add Selected</button>
          <button class="btn" id="historyBtn">History & Recall</button>
          <button class="btn" id="notifyBtn">Enable Notifications</button>
        </div>
      </div>
    </section>

    <!-- Today‚Äôs Focus -->
    <section class="section">
      <div class="outcome" id="outcomeBar"></div>
      <h2 class="h1" style="font-size:var(--fs-l)">Today‚Äôs Focus</h2>
      <div class="deck" id="focusGrid"></div>
    </section>

  </main>

  <div class="footer">
    <button class="soon-btn" id="devsBtn">ROM for Devs</button>
    <button class="soon-btn" id="soonBtn">Soon</button>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="card modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle" style="margin:0 0 8px">Modal</h3>
    <div id="modalBody" class="small">Loading‚Ä¶</div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
      <button class="btn danger" id="deleteTask" style="display:none">Delete</button>
      <button class="btn ghost" id="closeModal">Close</button>
      <button class="btn primary" id="saveTask" style="display:none">Save</button>
    </div>
  </div>
</div>

<!-- Undo snack -->
<div class="snack" id="snack"><span id="snackText">Action done.</span><button id="snackUndo">Undo</button></div>

<script>
(() => {
// ======= Polyfills =======
if (!('randomUUID' in crypto)) { crypto.randomUUID = () => 'rom-' + Math.random().toString(36).slice(2) + Date.now() }

// ======= State =======
const store={get(k,fb){try{return JSON.parse(localStorage.getItem(k))??fb}catch{return fb}},set(k,v){localStorage.setItem(k,JSON.stringify(v))}}
const todayKey=()=> new Date().toISOString().slice(0,10)
const DEFAULT_FOCUS={highlight:[],urgent:[],prepare:[]}
let focus=store.get('focus',DEFAULT_FOCUS)
let history=store.get('history',[])
let memory=store.get('memory',{people:{}, preferences:{}, patterns:{}, keywords:{}})
let settings=store.get('settings',{mode:'local', kill:false, notifications:false, apiKey:'', scopes:{calendar:'subjects', gmail:'subjects'}, connectors:{calendar:false, gmail:false}})
let metrics=store.get('metrics',{activation:{linked:false, firstSuggestionAccepted:false}, weekly:{followups:0,timeboxes:0,highlightDone:0}, streaks:{suggestAccept:0}, recalledRefs:0})
let activity=store.get('activity',[])
const lastSaved=store.get('lastDate',null)
if(lastSaved!==todayKey() && lastSaved!==null){
  history.unshift({date:lastSaved, focus})
  history=history.slice(0,30)
  focus={...DEFAULT_FOCUS}
  logAct('day-rollover', {from:lastSaved,to:todayKey()})
  saveAll()
}
store.set('lastDate',todayKey())

// ======= Utilities =======
const qs=(s)=>document.querySelector(s)
const qsa=(s)=>[...document.querySelectorAll(s)]
const val=(s)=>qs(s).value
function escapeHtml(str){return String(str).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}
function escapeAttr(str){return String(str).replace(/"/g,'&quot;')}
function saveAll(){ store.set('focus',focus); store.set('history',history); store.set('memory',memory); store.set('settings',settings); store.set('metrics',metrics); store.set('activity',activity) }
function logAct(type, detail){ activity.unshift({at:new Date().toISOString(), type, detail}); activity=activity.slice(0,200); saveAll() }
const undoStack=[]
function pushUndo(label, fn){ undoStack.push(fn); showSnack(label) }
function showSnack(label){ qs('#snackText').textContent=label; qs('#snack').classList.add('show'); setTimeout(()=>qs('#snack').classList.remove('show'), 6000) }

// ======= Memory & Recall =======
function extractPeopleAndKeywords(texts){
  const people=new Set(), keywords=new Set()
  const nameLike=/\b([A-Z][a-z]{2,})(?:\s+[A-Z][a-z]{2,})?\b/g
  const strongKeywords=/(invoice|advisor|deck|fundraising|tax|meeting|budget|proposal|design|launch|flight|hotel|dentist|doctor|groceries|workout|call|email|follow\s*up)/gi
  texts.forEach(t=>{
    let m; while((m=nameLike.exec(t))){ const n=m[1]; if(!['I','We','You','The','And','Buy','Plan','Finish','Email'].includes(n)) people.add(n) }
    const hits=t.match(strongKeywords); if(hits) hits.forEach(h=>keywords.add(h.toLowerCase()))
  })
  return {people:[...people], keywords:[...keywords]}
}
function updateMemoryFromFocus(){
  const lines=[]; ['highlight','urgent','prepare'].forEach(k=> (focus[k]||[]).forEach(it=>lines.push(it.text)))
  const {people, keywords}=extractPeopleAndKeywords(lines)
  const today=todayKey()
  people.forEach(n=>{
    const lastLine = lines.slice().reverse().find(l=> l.includes(n)) || n
    memory.people[n]={lastText:lastLine, lastDate:today}
  })
  keywords.forEach(k=> memory.keywords[k]=(memory.keywords[k]||0)+1)
  saveAll()
}
function renderRecallChips(){
  const wrap=qs('#recallChips'); if(!wrap) return; wrap.innerHTML=''
  const text=qs('#dayInput').value
  const names=(text.match(/\b([A-Z][a-z]{2,})(?:\s+[A-Z][a-z]{2,})?\b/g)||[]).filter(n=>memory.people[n])
  const seen=new Set()
  names.forEach(n=>{
    if(seen.has(n)) return; seen.add(n)
    const info=memory.people[n]
    const el=document.createElement('div'); el.className='chip'
    el.innerHTML=`<strong>${n}</strong><span class="small">Last: ${escapeHtml(info.lastText)}</span><button class="btn-mini" data-n="${n}">Add follow-up</button>`
    el.querySelector('.btn-mini').addEventListener('click', ()=>{ (focus.urgent ||= []).push({text:`Follow up with ${n} ‚Äî ${info.lastText}`, notes:'recall', done:false}); saveAll(); renderAll(); logAct('recall-follow', {name:n}) })
    wrap.appendChild(el)
  })
}

// ======= Suggestions =======
const SUG_TYPES={CARRY:'Carry-over', FOLLOW:'Follow-up', PREP:'Prep Idea', QUICK:'Quick Win', TIMEBOX:'Timebox', CHECKLIST:'Checklist'}
function stubCalendar(){ const d=new Date(); const time=('0'+(d.getHours()<14?14:d.getHours()+1)).slice(-2)+':00'; return [{title:'Advisor check-in', person:'Michelle', time}] }
function stubGmail(){ return [{from:'Michelle', subject:'Advisor call next steps'}] }
function buildSuggestions(){
  if(settings.kill) return []
  const sugg=[]
  history.slice(0,3).forEach(h=>{
    ['highlight','urgent','prepare'].forEach(k=>{
      (h.focus[k]||[]).forEach(it=>{
        if(!it.done) sugg.push({type:SUG_TYPES.CARRY, text:it.text, from:h.date, source:'Local', explain:`Undone ${k} from ${h.date}`})
      })
    })
  })
  Object.entries(memory.people||{}).forEach(([name, last])=>{
    const hinted=/email|call|follow\s*up|meeting|advisor|proposal|deck|invoice/i.test(last.lastText)
    if(hinted) sugg.push({type:SUG_TYPES.FOLLOW, text:`Follow up with ${name} ‚Äî ${last.lastText}`, source:'Local', explain:`Mentioned with action-y context on ${last.lastDate}`})
  })
  if(settings.connectors.calendar) { stubCalendar().forEach(ev=>{ if(ev.person) sugg.push({type:SUG_TYPES.FOLLOW, text:`Prep for ${ev.title} with ${ev.person} at ${ev.time}`, source:'Calendar', explain:`Upcoming event today at ${ev.time}`}) }) }
  if(settings.connectors.gmail)    { stubGmail().forEach(mail=> sugg.push({type:SUG_TYPES.FOLLOW, text:`Reply: ${mail.subject}`, source:'Email', explain:`Recent email from ${mail.from}`}) ) }
  if(memory.keywords.flight||memory.keywords.hotel) sugg.push({type:SUG_TYPES.CHECKLIST, text:'Travel checklist (docs, tickets, chargers, meds)', source:'Local', explain:'You mentioned flights/hotel before'})
  if(memory.keywords.demo||memory.keywords.launch||memory.keywords.deck) sugg.push({type:SUG_TYPES.CHECKLIST, text:'Demo prep checklist (script, env, backup video)', source:'Local', explain:'You mentioned demo/launch/deck previously'})
  const total=['highlight','urgent','prepare'].reduce((a,k)=>a+(focus[k]||[]).length,0)
  if(total>=6) sugg.push({type:SUG_TYPES.QUICK, text:'Two-minute rule sweep (reply/triage 10m)', source:'Local', explain:'List is heavy; reduce friction with quick wins'})
  sugg.push({type:SUG_TYPES.TIMEBOX, text:'Auto timebox: AM highlight, midday urgents, PM prep', source:(settings.mode==='cloud'?'Cloud':'Local'), explain:'Simple schedule heuristic'})
  const uniq={}; return sugg.filter(s=> (uniq[s.text]? false : (uniq[s.text]=true)))
}
function renderAssist(){
  updateMemoryFromFocus()
  const wrap=qs('#assistList'); if(!wrap) return; wrap.innerHTML=''
  const suggs=buildSuggestions(); wrap.dataset.payload=JSON.stringify(suggs)
  if(!suggs.length){ wrap.innerHTML='<div class="small">No suggestions yet. Add some tasks or tap Demo.</div>'; return }
  suggs.forEach((s,i)=>{
    const row=document.createElement('div'); row.className='suggestion'; row.dataset.index=i
    row.innerHTML=`
      <span class="tag ${s.type===SUG_TYPES.CARRY?'orange':s.type===SUG_TYPES.FOLLOW?'green':''}">${s.type}</span>
      <div>
        <div><strong>${escapeHtml(s.text)}</strong></div>
        <div style="margin-top:4px;display:flex;gap:6px;align-items:center">
          <span class="source">${s.source}</span>
          <button class="btn-xxs explain-btn">Explain</button>
          <button class="btn-xxs snooze-btn">Snooze</button>
        </div>
        <div class="explain">${escapeHtml(s.explain||'')}</div>
      </div>
      <div class="actions">
        ${s.type===SUG_TYPES.FOLLOW?'<button class="btn-xxs compose-btn">Compose</button>':''}
        <label class="btn-xxs"><input type="checkbox" class="addChk" /> Add</label>
      </div>`
    wrap.appendChild(row)
  })
}

// ======= Focus & Outcome =======
const DECK_META=[{key:'highlight',label:"Today‚Äôs Highlight",color:'green'},{key:'urgent',label:'Urgent',color:'orange'},{key:'prepare',label:'Prepare',color:'blue'}]
function renderDeck(){
  const grid=qs('#focusGrid'); if(!grid) return; grid.innerHTML=''
  DECK_META.forEach(def=>{
    const items=focus[def.key]||[]; const count=items.filter(i=>!i.done).length
    const el=document.createElement('article'); el.className='card-focus'; el.dataset.key=def.key
    el.innerHTML=`
      <div class="focus-head">
        <h3 class="focus-title">${def.label}</h3>
        <span class="badge ${def.color}">${count} ${count===1?'item':'items'}</span>
      </div>
      <div class="focus-body">
        <ul class="tasks">
          ${items.length?items.slice(0,48).map((i,idx)=>`
            <li class="taskli ${i.done?'done':''}" data-idx="${idx}">
              <span class="txt">${escapeHtml(i.text)}</span>
              <button class="mini-done" title="${i.done?'Mark not done':'Mark done'}">${i.done?'‚Ü∫':'‚úì'}</button>
            </li>`).join(''):'<li class="small">No items yet.</li>'}
        </ul>
      </div>
      <div class="focus-foot">
        <button class="tick">‚úî Mark all done</button>
        <button class="plain">Edit‚Ä¶</button>
      </div>`
    // event wiring per card
    el.querySelector('.tick').addEventListener('click', ()=>{
      const prev=JSON.stringify(focus[def.key]); focus[def.key]=(focus[def.key]||[]).map(i=>({...i,done:true}));
      pushUndo('Marked all done.', ()=>{ focus[def.key]=JSON.parse(prev); saveAll(); renderAll() }); saveAll(); renderAll(); if(def.key==='highlight') metrics.weekly.highlightDone += 1; saveAll(); logAct('mark-all', {list:def.key})
    })
    el.querySelector('.plain').addEventListener('click', ()=>openListEditor(def.key))
    el.querySelectorAll('.taskli').forEach(li=>{
      const idx=+li.dataset.idx
      li.querySelector('.mini-done').addEventListener('click', (ev)=>{ ev.stopPropagation(); const prev=focus[def.key][idx].done; focus[def.key][idx].done=!prev; pushUndo(prev?'Marked not done.':'Marked done.', ()=>{ focus[def.key][idx].done=prev; saveAll(); renderAll() }); saveAll(); renderAll() })
      li.addEventListener('click', ()=>openItemEditor(def.key, idx))
    })
    grid.appendChild(el)
  })
}
function renderOutcome(){
  const el=qs('#outcomeBar'); if(!el) return
  const doneCounts=DECK_META.map(d=>(focus[d.key]||[]).filter(i=>i.done).length)
  const totalCounts=DECK_META.map(d=>(focus[d.key]||[]).length)
  const impact = Math.round( ( (doneCounts[0]*3 + doneCounts[1]*2 + doneCounts[2]*1) / Math.max(1,(totalCounts[0]*3+totalCounts[1]*2+totalCounts[2]*1)) ) * 100 )
  el.innerHTML=`
    <span class="out-pill">Highlight: ${doneCounts[0]}/${totalCounts[0]}</span>
    <span class="out-pill">Urgent: ${doneCounts[1]}/${totalCounts[1]}</span>
    <span class="out-pill">Prepare: ${doneCounts[2]}/${totalCounts[2]}</span>
    <span class="out-pill">Impact <span class="score">${isNaN(impact)?0:impact}%</span></span>`
}

// ======= Editors & Modal =======
const modal=qs('#modal'), modalTitle=qs('#modalTitle'), modalBody=qs('#modalBody'), closeModalBtn=qs('#closeModal'), saveBtn=qs('#saveTask'), deleteBtn=qs('#deleteTask')
function openModal(){ modal.classList.add('open') }
function closeModal(){ modal.classList.remove('open'); saveBtn.onclick=null; deleteBtn.onclick=null }
closeModalBtn.addEventListener('click', closeModal)
modal.addEventListener('click',e=>{ if(e.target===modal) closeModal() })

function openListEditor(key){
  modalTitle.textContent={highlight:"Today‚Äôs Highlight", urgent:"Urgent", prepare:"Prepare"}[key]
  saveBtn.style.display='inline-flex'; deleteBtn.style.display='none'
  modalBody.innerHTML=`
    <div class="small">Bulk edit ‚Äî one per line. Use <strong>[x]</strong> for done. Add notes after ‚Äú ‚Äî ‚Äù.</div>
    <textarea class="modal-input" id="taskEdit">${(focus[key]||[]).map(i=>(i.done?'[x] ':'')+i.text+(i.notes?` ‚Äî ${i.notes}`:'')).join('\n')}</textarea>`
  const prev=JSON.stringify(focus[key]||[])
  saveBtn.onclick=()=>{
    const lines=qs('#taskEdit').value.split(/\n+/).map(s=>s.trim()).filter(Boolean)
    focus[key]=lines.map(l=>{
      const done=/^\[x\]\s*/i.test(l); const clean=l.replace(/^\[x\]\s*/i,''); const parts=clean.split(' ‚Äî ')
      return {text:parts[0], notes:parts.slice(1).join(' ‚Äî '), done}
    })
    pushUndo('Edited list.', ()=>{ focus[key]=JSON.parse(prev); saveAll(); renderAll() })
    saveAll(); renderAll(); closeModal()
  }
  openModal()
}
function openItemEditor(key, idx){
  const item=focus[key][idx] || {text:'',notes:'',done:false,when:''}
  modalTitle.textContent='Edit Task'
  saveBtn.style.display='inline-flex'; deleteBtn.style.display='inline-flex'
  const prev=JSON.stringify(item)
  modalBody.innerHTML=`
    <div class="form-row"><div class="label">List</div><div>${{highlight:"Today‚Äôs Highlight",urgent:"Urgent",prepare:"Prepare"}[key]}</div></div>
    <div class="form-row"><label class="label" for="itext">Text</label><input id="itext" type="text" value="${escapeAttr(item.text)}"/></div>
    <div class="form-row"><label class="label" for="inotes">Notes</label><input id="inotes" type="text" placeholder="optional" value="${escapeAttr(item.notes||'')}"/></div>
    <div class="form-row"><label class="label" for="iwhen">When</label><input id="iwhen" type="datetime-local" value="${item.when||''}"/></div>
    <div class="form-row"><div class="label">Status</div><label><input id="idone" type="checkbox" ${item.done?'checked':''}/> Done</label></div>`
  saveBtn.onclick=()=>{ focus[key][idx]={text:val('#itext'), notes:val('#inotes'), when:val('#iwhen'), done:qs('#idone').checked}; pushUndo('Edited task.', ()=>{ focus[key][idx]=JSON.parse(prev); saveAll(); renderAll() }); saveAll(); renderAll(); closeModal() }
  deleteBtn.onclick=()=>{ const del=focus[key].splice(idx,1)[0]; pushUndo('Deleted task.', ()=>{ focus[key].splice(idx,0,del); saveAll(); renderAll() }); saveAll(); renderAll(); closeModal() }
  openModal()
}

// ======= Day in a Life buttons =======
const demoText=['Finish fundraising deck v3','Email Michelle about advisor call','Gym + stretch 45m','Schedule dentist appointment','Buy groceries for dinner','Sketch ROM ‚Äúmemory constellations‚Äù','Plan EU trip budget'].join('\n')
qs('#demoBtn').addEventListener('click', ()=>{qs('#dayInput').value=demoText; renderRecallChips()})
qs('#clearBtn').addEventListener('click', ()=>{ const prev=JSON.stringify(focus); qs('#dayInput').value=''; focus={...DEFAULT_FOCUS}; pushUndo('Cleared.', ()=>{ focus=JSON.parse(prev); saveAll(); renderAll() }); saveAll(); renderAll() })
qs('#makeBtn').addEventListener('click', ()=>{
  const raw=qs('#dayInput').value.trim(); const parts=raw.split(/[\n,;]+/).map(s=>s.trim()).filter(Boolean)
  if(!parts.length){ alert('Add a few items first (or tap Demo).'); return }
  const urgentWords=/(urgent|asap|due|invoice|tax|email|call|reply|submit|meeting|today|flight|check-in)/i
  const prepareWords=/(book|schedule|plan|prep|prepare|buy|order|research|pack|budget|draft|outline)/i
  const prev=JSON.stringify(focus)
  let highlight=[], urgent=[], prepare=[]
  parts.forEach(p=>{
    if(urgentWords.test(p))       urgent.push({text:p,done:false,notes:''})
    else if(prepareWords.test(p)) prepare.push({text:p,done:false,notes:''})
    else if(highlight.length<3)   highlight.push({text:p,done:false,notes:''})
    else                          prepare.push({text:p,done:false,notes:''})
  })
  if(highlight.length>0) highlight=[highlight[0], ...highlight.slice(1,3)]
  focus={highlight,urgent,prepare}
  pushUndo('Planned your day.', ()=>{ focus=JSON.parse(prev); saveAll(); renderAll() })
  saveAll(); renderAll(); qs('#focusGrid').scrollIntoView({behavior:'smooth', block:'start'})
})

// Focus timer & water
let focusTimer=null, endAt=0
const fmt=ms=>`${String(Math.floor(ms/60000)).padStart(2,'0')}:${String(Math.floor((ms%60000)/1000)).padStart(2,'0')}`
qs('#focusBtn').addEventListener('click', ()=>{
  const label=qs('#focusStatus')
  if(focusTimer){ clearInterval(focusTimer); focusTimer=null; label.textContent='Focus stopped.'; return }
  endAt=Date.now()+25*60*1000; label.textContent='25:00'
  focusTimer=setInterval(()=>{ const left=endAt-Date.now(); if(left<=0){ clearInterval(focusTimer); focusTimer=null; label.textContent='Time! Great job.'; alert('Focus block done!') } else label.textContent=fmt(left) }, 250)
})
qs('#waterBtn').addEventListener('click', ()=>alert('Sip water üíß'))

// ======= AI Assist controls (delegated) =======
qs('#assistList').addEventListener('click', (e)=>{
  const row=e.target.closest('.suggestion'); if(!row) return
  const i=+row.dataset.index
  if(e.target.classList.contains('explain-btn')){ const exp=row.querySelector('.explain'); exp.style.display=exp.style.display==='block'?'none':'block'; return }
  if(e.target.classList.contains('snooze-btn')){ showSnack('Snoozed for later.'); logAct('snooze', {index:i}); return }
  if(e.target.classList.contains('compose-btn')){ const s=JSON.parse(qs('#assistList').dataset.payload||'[]')[i]; openCompose(s); return }
})
qs('#refreshAssist').addEventListener('click', ()=>renderAssist())
qs('#addSelected').addEventListener('click', ()=>{
  const data=JSON.parse(qs('#assistList').dataset.payload||'[]')
  const checks=[...qsa('#assistList .addChk')].map((c,idx)=>c.checked?idx:null).filter(v=>v!==null)
  if(!checks.length){ alert('Select at least one suggestion.'); return }
  const prev=JSON.stringify(focus)
  checks.forEach(i=>{
    const s=data[i]; if(!s) return
    if(s.type===SUG_TYPES.FOLLOW) (focus.urgent ||= []).push({text:s.text, done:false, notes:'AI follow-up'})
    else if(s.type===SUG_TYPES.CARRY){ if((focus.highlight||[]).length===0) (focus.highlight ||= []).push({text:s.text, done:false, notes:'carry-over'}); else (focus.urgent ||= []).push({text:s.text, done:false, notes:'carry-over'}) }
    else if(s.type===SUG_TYPES.PREP) (focus.prepare ||= []).push({text:s.text, done:false, notes:'prep idea'})
    else if(s.type===SUG_TYPES.QUICK) (focus.urgent ||= []).push({text:s.text, done:false, notes:'quick win'})
    else if(s.type===SUG_TYPES.CHECKLIST) (focus.prepare ||= []).push({text:s.text, done:false, notes:'checklist'})
    else if(s.type===SUG_TYPES.TIMEBOX) timeboxDay(true)
  })
  pushUndo('Added suggestions.', ()=>{ focus=JSON.parse(prev); saveAll(); renderAll() })
  metrics.activation.firstSuggestionAccepted = metrics.activation.firstSuggestionAccepted || checks.length>0
  metrics.streaks.suggestAccept += 1
  saveAll(); renderAll(); logAct('suggest-add', {count:checks.length})
})
qs('#historyBtn').addEventListener('click', ()=>{
  modalTitle.textContent='History & Recall'; saveBtn.style.display='none'; deleteBtn.style.display='none'
  if(!history.length){ modalBody.innerHTML='<div class="small">No previous agendas yet.</div>'; openModal(); return }
  let html='<div class="assist">'
  history.slice(0,10).forEach((h,i)=>{
    const c= ['highlight','urgent','prepare'].map(k=>(h.focus[k]||[]).filter(x=>!x.done).length).reduce((a,b)=>a+b,0)
    html+=`<div class="suggestion"><span class="tag">${h.date}</span><span>Undone items: ${c}</span><button class="btn-xxs" data-imp="${i}" style="margin-left:auto">Import undone</button></div>`
  }); html+='</div>'
  modalBody.innerHTML=html
  modalBody.querySelectorAll('[data-imp]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const i=+btn.dataset.imp; const h=history[i]; const prev=JSON.stringify(focus);
      ['highlight','urgent','prepare'].forEach(k=> (h.focus[k]||[]).filter(x=>!x.done).forEach(x=> { if(!(focus[k]||[]).some(y=>y.text.toLowerCase()===x.text.toLowerCase())) (focus[k] ||= []).push({...x, done:false, notes:(x.notes||'')+' (from '+h.date+')'}) }))
      pushUndo('Imported from history.', ()=>{ focus=JSON.parse(prev); saveAll(); renderAll() }); saveAll(); renderAll(); logAct('history-import',{date:h.date}); closeModal()
    })
  })
  openModal()
})
qs('#notifyBtn').addEventListener('click', async()=>{
  if(!('Notification' in window)){ alert('Notifications are not supported in this browser.'); return }
  if(Notification.permission==='granted'){ settings.notifications=true; saveAll(); alert('Notifications enabled.'); return }
  const p=await Notification.requestPermission(); settings.notifications=(p==='granted'); saveAll(); alert(settings.notifications? 'Notifications enabled.' : 'Permission denied.')
})

// ======= Timebox & ICS =======
qs('#timeboxBtn').addEventListener('click', ()=>timeboxDay())
function timeboxDay(silent){
  const now=new Date(); const base=new Date(now); base.setHours(9,0,0,0)
  const blocks=[]
  if((focus.highlight||[])[0]) blocks.push({t:'Focus: '+focus.highlight[0].text, at:addMins(base,0)})
  ;(focus.urgent||[]).slice(0,2).forEach((u,i)=> blocks.push({t:'Urgent: '+u.text, at:addMins(base,(i===0?120:270))}))
  ;(focus.prepare||[]).slice(0,1).forEach(p=> blocks.push({t:'Prep: '+p.text, at:addMins(base,420)}))
  openTimeboxModal(blocks, silent===true)
  metrics.weekly.timeboxes += 1; saveAll()
}
function addMins(base, m){ return new Date(base.getTime()+m*60000) }
function fmtHHMM(d){ return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0') }
function openTimeboxModal(blocks, silent){
  modalTitle.textContent='Timeboxed Plan'
  saveBtn.style.display='inline-flex'; deleteBtn.style.display='none'
  let html='<div class="small">A lightweight schedule for today. Toggle reminders after enabling notifications.</div>'
  html+='<div class="assist" style="margin-top:8px">'
  blocks.forEach((b,i)=>{ html+=`<div class="suggestion"><span class="tag">${fmtHHMM(b.at)}</span><span>${escapeHtml(b.t)}</span>
    <label style="margin-left:auto" class="small"><input type="checkbox" data-ridx="${i}" class="remChk" /> remind me</label></div>` })
  html+='</div><div class="btns" style="margin-top:10px"><button class="btn" id="icsBtn">Export .ics</button></div>'
  modalBody.innerHTML=html
  qs('#icsBtn').addEventListener('click', ()=> exportICS(blocks))
  saveBtn.onclick=()=>{
    if(settings.notifications && 'Notification' in window){
      qsa('.remChk:checked').forEach((c)=>{
        const idx=+c.dataset.ridx; scheduleReminder(blocks[idx].at, blocks[idx].t)
      })
      alert('Reminders set for today.')
    }else alert('Enable notifications first in AI Assist.')
    closeModal()
  }
  if(!silent) openModal()
}
function exportICS(blocks){
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//ROM//Twin//EN']
  blocks.forEach(b=>{
    const dt=toICSDateTime(b.at); const dtEnd=toICSDateTime(new Date(b.at.getTime()+30*60000))
    lines.push('BEGIN:VEVENT','UID:'+crypto.randomUUID(),'DTSTAMP:'+toICSDateTime(new Date()),'DTSTART:'+dt,'DTEND:'+dtEnd,'SUMMARY:'+b.t,'END:VEVENT')
  })
  lines.push('END:VCALENDAR')
  const blob=new Blob([lines.join('\r\n')], {type:'text/calendar'})
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rom-timebox.ics'; a.click()
}
function toICSDateTime(d){ return d.getUTCFullYear()+String(d.getUTCMonth()+1).padStart(2,'0')+String(d.getUTCDate()).padStart(2,'0')+'T'+String(d.getUTCHours()).padStart(2,'0')+String(d.getUTCMinutes()).padStart(2,'0')+'00Z' }
function scheduleReminder(when, text){ const ms=when - new Date(); if(ms>0) setTimeout(()=>{ new Notification('ROM Reminder',{body:text}) }, ms) }

// ======= Compose & Email Analyze =======
function openCompose(sugg){
  modalTitle.textContent='Follow-up Composer'
  saveBtn.style.display='none'; deleteBtn.style.display='none'
  const who=(sugg.text.match(/with\s+([A-Z][a-z]+)/)||[])[1]||''
  const subj=`Re: ${sugg.text.replace(/^Follow up with\s*/,'')}`
  const body=`Hi ${who||''},\n\nFollowing up on ${sugg.text.replace(/^Follow up with\s*/,'').toLowerCase()}.\n\n- ${todayKey()} ‚Äî quick update:\n\nBest,\n`
  modalBody.innerHTML=`<div class="form-row"><div class="label">Subject</div><input type="text" id="subj" value="${escapeAttr(subj)}"/></div>
  <div class="form-row"><div class="label">Body</div><textarea class="modal-input" id="body" rows="6">${escapeHtml(body)}</textarea></div>
  <div class="btns"><a class="btn" id="mailto">Open Mail</a><button class="btn" id="copyMail">Copy</button></div>`
  qs('#mailto').addEventListener('click', ()=>{ const u='mailto:?subject='+encodeURIComponent(val('#subj'))+'&body='+encodeURIComponent(val('#body')); location.href=u })
  qs('#copyMail').addEventListener('click', ()=>{ navigator.clipboard.writeText('Subject: '+val('#subj')+'\n\n'+val('#body')); showSnack('Copied draft.') })
  openModal()
}
qs('#pasteEmailBtn').addEventListener('click', ()=>{
  modalTitle.textContent='Analyze Email (Local)'; saveBtn.style.display='inline-flex'; deleteBtn.style.display='none'
  modalBody.innerHTML=`<div class="small">Paste an email; we‚Äôll extract follow-ups locally (no upload).</div>
  <textarea class="modal-input" id="emailPaste" rows="10" placeholder="Paste email text here..."></textarea>`
  saveBtn.onclick=()=>{
    const t=val('#emailPaste'); if(!t.trim()) return closeModal()
    const who=(t.match(/From:\s*([^\n<]+)/i)||[])[1] || (t.match(/\b([A-Z][a-z]+)\b/)||[])[1] || 'Contact'
    const subj=(t.match(/Subject:\s*([^\n]+)/i)||[])[1] || 'your last email'
    ;(focus.urgent ||= []).push({text:`Follow up with ${who} ‚Äî ${subj}`, notes:'email paste', done:false})
    saveAll(); renderAll(); logAct('email-analyze',{who,subj}); closeModal()
  }
  openModal()
})

// ======= Privacy Center & Memory Inspector & Footer =======
qs('#privacyBtn').addEventListener('click', ()=>{
  modalTitle.textContent='Privacy Center'; saveBtn.style.display='inline-flex'; deleteBtn.style.display='inline-flex'
  modalBody.innerHTML=renderPrivacyHTML()
  saveBtn.onclick=()=>{
    settings.mode = qs('#modeSel').value
    settings.apiKey = val('#apiKey')
    settings.scopes.calendar = qs('#scopeCal').value
    settings.scopes.gmail    = qs('#scopeMail').value
    settings.connectors.calendar = qs('#connCal').checked
    settings.connectors.gmail    = qs('#connMail').checked
    metrics.activation.linked = metrics.activation.linked || settings.connectors.calendar || settings.connectors.gmail
    saveAll(); renderAssist(); updateModeBadge(); closeModal()
  }
  deleteBtn.onclick=()=>{ if(confirm('Kill Switch will pause AI features until re-enabled. Continue?')){ settings.kill=!settings.kill; saveAll(); renderAll(); updateModeBadge(); modalBody.innerHTML=renderPrivacyHTML() } }
  openModal()
})
qs('#memoryBtn').addEventListener('click', ()=>{
  modalTitle.textContent='Twin Memory'
  saveBtn.style.display='inline-flex'; deleteBtn.style.display='inline-flex'
  modalBody.innerHTML=renderMemoryHTML()
  saveBtn.onclick=()=>{ memory.preferences.freeText=(qs('#prefInput').value||'').trim(); saveAll(); renderAssist(); closeModal() }
  deleteBtn.onclick=()=>{ if(confirm('Clear all memory?')){ memory={people:{},preferences:{},patterns:{},keywords:{}}; saveAll(); renderAssist(); closeModal() } }
  openModal()
})
qs('#devsBtn').addEventListener('click', ()=>{
  modalTitle.textContent='ROM for Devs'
  saveBtn.style.display='none'; deleteBtn.style.display='none'
  modalBody.innerHTML=`<div class="small">Local API (experimental):</div>
<pre style="white-space:pre-wrap;background:#f8fafc;border:1px solid #e5e7eb;padding:10px;border-radius:12px;font-size:12px">
await window.ROMAPI.getSuggestions()
await window.ROMAPI.getMemory()
await window.ROMAPI.setMemory('people.Michelle', {lastText:'advisor call next steps', lastDate:'${todayKey()}'})
</pre>`
  openModal()
})
qs('#soonBtn').addEventListener('click', ()=>{ modalTitle.textContent='Coming Soon'; modalBody.textContent='This is a glimpse ‚Äî much more coming soon.'; saveBtn.style.display='none'; deleteBtn.style.display='none'; openModal() })

function renderPrivacyHTML(){
  return `
  <div class="assist">
    <div class="suggestion"><span class="tag">Mode</span>
      <div>
        <div>Processing: <select id="modeSel"><option value="local" ${settings.mode==='local'?'selected':''}>Local-only</option><option value="cloud" ${settings.mode==='cloud'?'selected':''}>Cloud (BYOK)</option></select></div>
        <div style="margin-top:6px"><input id="apiKey" type="text" placeholder="API key (kept locally)" value="${escapeAttr(settings.apiKey||'')}" /></div>
        <div class="small">Features show a badge for Local / Cloud. BYOK is optional.</div>
      </div>
      <span class="source">${settings.kill?'KILL ON':'KILL OFF'}</span>
    </div>
    <div class="small"><strong>Data sources & scopes</strong></div>
    <div class="suggestion">
      <span class="tag">Calendar</span>
      <div>
        <label><input type="checkbox" id="connCal" ${settings.connectors.calendar?'checked':''}/> Enable (demo)</label>
        <div class="small">Scope: <select id="scopeCal"><option value="subjects" ${settings.scopes.calendar==='subjects'?'selected':''}>subjects only</option><option value="headers" ${settings.scopes.calendar==='headers'?'selected':''}>headers only</option></select></div>
      </div>
    </div>
    <div class="suggestion">
      <span class="tag">Gmail</span>
      <div>
        <label><input type="checkbox" id="connMail" ${settings.connectors.gmail?'checked':''}/> Enable (demo)</label>
        <div class="small">Scope: <select id="scopeMail"><option value="subjects" ${settings.scopes.gmail==='subjects'?'selected':''}>subjects only</option><option value="headers" ${settings.scopes.gmail==='headers'?'selected':''}>headers only</option></select></div>
      </div>
    </div>
    <div class="small"><strong>Vault</strong></div>
    <div class="suggestion">
      <span class="tag">Export</span>
      <div><button class="btn-xxs" onclick="(${exportVault.toString()})()">Download JSON</button></div>
      <div><input type="file" id="vaultFile" accept="application/json" /><button class="btn-xxs" onclick="(${importVault.toString()})()">Import</button></div>
    </div>
    <div class="small"><strong>Activity Log</strong></div>
    <div class="assist" style="max-height:220px; overflow:auto; border:1px solid var(--stroke); border-radius:12px; padding:8px">
      ${activity.slice(0,40).map(a=>`<div class="small">[${a.at}] ${a.type} ‚Äî ${escapeHtml(JSON.stringify(a.detail||{}))}</div>`).join('') || '<div class="small">No activity yet.</div>'}
    </div>
  </div>`
}
function renderMemoryHTML(){
  const peopleHTML=Object.entries(memory.people||{}).map(([n,v])=>`
    <div class="suggestion"><span class="tag">${n}</span><span>${escapeHtml(v.lastText)} <span class="small">(${v.lastDate})</span></span>
      <button class="btn-xxs" onclick="(function(){delete window.__mem.people['${n}']; (${saveAll.toString()})(); (${renderAssist.toString()})(); document.getElementById('modalBody').innerHTML=(${renderMemoryHTML.toString()})(); })()">Remove</button>
    </div>`).join('') || '<div class="small">No people yet.</div>'
  const pref=memory.preferences?.freeText||''
  const pat=Object.entries(memory.patterns||{}).map(([k,v])=>`<div class="suggestion"><span class="tag">${k}</span><span>${escapeHtml(v)}</span></div>`).join('') || '<div class="small">No patterns yet.</div>'
  window.__mem=memory
  return `
    <div class="assist">
      <div class="small"><strong>People</strong></div>${peopleHTML}
      <div class="small" style="margin-top:8px"><strong>Preferences</strong></div>
      <textarea class="modal-input" id="prefInput" rows="3" placeholder="food, travel, work hours‚Ä¶">${escapeHtml(pref)}</textarea>
      <div class="small" style="margin-top:8px"><strong>Patterns</strong></div>${pat}
    </div>`
}
function exportVault(){
  const blob=new Blob([JSON.stringify({focus,history,memory,settings,metrics,activity},null,2)],{type:'application/json'})
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rom-vault.json'; a.click()
}
function importVault(){
  const f=qs('#vaultFile')?.files?.[0]; if(!f) return
  const r=new FileReader(); r.onload=()=>{ try{
    const d=JSON.parse(r.result); focus=d.focus||focus; history=d.history||history; memory=d.memory||memory; settings=d.settings||settings; metrics=d.metrics||metrics; activity=d.activity||activity; saveAll(); renderAll(); alert('Imported.') }catch(e){ alert('Invalid file.') } }
  r.readAsText(f)
}
function updateModeBadge(){ qs('#modeBadge').textContent=settings.kill?'Paused (Kill)':(settings.mode==='cloud'?'Cloud (BYOK)':'Local-only') }

// ======= Dev API (window.ROMAPI) =======
window.ROMAPI={
  getSuggestions: async ()=> buildSuggestions(),
  getMemory: async ()=> memory,
  setMemory: async (path,value)=>{ const parts=path.split('.'); let obj=memory; for(let i=0;i<parts.length-1;i++){ obj=obj[parts[i]] ||= {} } obj[parts.at(-1)]=value; saveAll(); return {ok:true} }
}

// ======= Render-all =======
function renderAll(){ renderDeck(); renderAssist(); renderOutcome(); renderRecallChips(); updateModeBadge() }
qs('#dayInput').addEventListener('input', renderRecallChips)

// ======= Boot =======
renderAll()

})(); // IIFE
</script>
</body>
</html>
