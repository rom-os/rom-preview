<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ROM — Everyday AI</title>
  <meta name="description" content="ROM — organize your life from messages, files, reminders into smart cards. Local-first, no servers." />
  <style>
    :root{
      --bg:#FFFFFF; --panel:#FFFFFF; --surface:#FFFFFF; --surface-2:#F6F7FB; --stroke:#E8EDF4;
      --ink:#0B1220; --muted:#667085; --accent:#0A84FF; --accent-2:#6AA3FF;
      --green:#2ECC71; --orange:#FF9F0A; --red:#EF4444; --purple:#6B5BCE; --blue:#0A84FF; --gray:#98A2B3;
      --radius:16px; --shadow:0 10px 28px rgba(15,17,22,0.10);
      --fs-xs:12px; --fs-s:14px; --fs-m:16px; --fs-l:20px; --fs-xl:28px; --fs-xxl:36px;
    }
    *{box-sizing:border-box}
    body{margin:0;color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg)}
    body::before{content:""; position:fixed; inset:0; z-index:-1; background:
      radial-gradient(circle at 20% 20%, rgba(234, 242, 255, 0.8) 0%, transparent 50%),
      radial-gradient(circle at 80% 10%, rgba(255, 234, 242, 0.6) 0%, transparent 50%),
      radial-gradient(circle at 60% 90%, rgba(240, 245, 255, 0.4) 0%, transparent 50%),
      linear-gradient(135deg, #FFFFFF 0%, #F8FAFF 40%, #F0F5FF 70%, #FFFFFF 100%);
    }
    .container{max-width:1120px;margin:0 auto;padding:24px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .brand{font-weight:800;font-size:18px;letter-spacing:.4px}
    .actions{display:flex;gap:8px}
    .btn{padding:10px 16px;border-radius:12px;border:1px solid var(--stroke);background:#fff;cursor:pointer;transition:transform .06s ease, box-shadow .2s, border-color .2s; font-size:14px; color:var(--ink); display:inline-flex; align-items:center; gap:8px}
    .btn:focus{outline:3px solid rgba(10,132,255,.25); outline-offset:2px}
    .btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 10px 24px rgba(0,0,0,.06); border-color:#D5DEEA}
    .btn:active:not(:disabled){transform:translateY(0)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.success{background:var(--green);color:#fff;border-color:var(--green)}
    .btn.warning{background:var(--orange);color:#fff;border-color:var(--orange)}
    .spinner{width:14px;height:14px;border:2px solid rgba(255,255,255,.6);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .statusbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px;color:var(--muted);font-size:12px}
    .pill{padding:4px 8px;border:1px dashed var(--stroke);border-radius:999px}

    .hero{background:#fff;border:1px solid var(--stroke);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);margin-bottom:20px}
    .hero-title{font-size:var(--fs-xxl);font-weight:800;margin-bottom:6px}
    textarea{width:100%;min-height:120px;padding:12px;border-radius:12px;border:1px solid var(--stroke);background:var(--surface-2);color:var(--ink)}

    .section h2{font-size:var(--fs-xl);margin:12px 0}
    .lanes{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .lane{background:linear-gradient(180deg,#FFFFFF 0%, #F8FAFF 70%, #FFFFFF 100%); border:1px solid var(--stroke); border-radius:16px; padding:12px; box-shadow:var(--shadow)}
    .lane h3{margin:0 0 8px 0;font-size:16px;color:#0B1220}

    .skeleton{height:96px;border-radius:14px;background:linear-gradient(90deg,#f3f4f8 25%, #e9ecf4 37%, #f3f4f8 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
    .card{background:#fff;border:1px solid var(--stroke);border-radius:14px;box-shadow:var(--shadow);padding:14px;margin-bottom:10px}
    .card-header{display:flex;align-items:flex-start;gap:10px;margin-bottom:6px}
    .prio{width:8px;height:8px;border-radius:50%;margin-top:7px}
    .prio.red{background:var(--red)} .prio.orange{background:var(--orange)} .prio.green{background:var(--green)}
    .title{font-weight:700; font-size:var(--fs-m)}
    .meta-row{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin:6px 0}
    details.rationale{margin-top:6px}
    details.rationale>summary{list-style:none; cursor:pointer; color:#0A84FF; font-size:12px}
    details.rationale>summary::-webkit-details-marker{display:none}
    .why{margin-top:6px;color:#334155;font-size:13px;background:#F8FAFF;padding:10px;border-radius:10px;border:1px solid #D7E3FF}
    .card-actions{margin-top:10px;display:flex;gap:6px;flex-wrap:wrap}

    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:18px;padding-top:12px;border-top:1px solid var(--stroke);color:var(--muted);font-size:13px}

    .toast{position:fixed;right:16px;bottom:16px;background:#0B1220;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.2);z-index:9999;font-size:13px;opacity:0;transition:opacity .2s;pointer-events:none}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:60}
    .modal[open]{display:flex}
    .modal-box{background:#fff;border:1px solid var(--stroke);border-radius:18px;padding:20px;max-width:920px;width:92%;box-shadow:var(--shadow);position:relative;max-height:82vh;overflow-y:auto}
    .modal-topbar{position:sticky;top:0;background:#fff;padding:6px 4px 8px;display:flex;gap:8px;justify-content:space-between;border-bottom:1px solid var(--stroke); z-index:2}
    .modal-close{border:1px solid var(--stroke);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer}

    .apps{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;margin:12px 0}
    .app{border:1px solid var(--stroke);border-radius:12px;padding:12px;background:#FAFBFF;display:flex;flex-direction:column;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;font-size:12px;border:1px solid var(--stroke);}
    .chip.gray{background:#F6F7FB;color:#475467}
    .chip.blue{background:#E7F0FF;color:#1849A9;border-color:#C2DAFF}
    .chip.purple{background:#EEE9FF;color:#463AA8;border-color:#D5CCFF}
    .chip.green{background:#E8F5E8;color:#116A28;border-color:#CBEFD0}
    .meta{color:var(--muted);font-size:12px}

    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">ROM</div>
      <div class="actions">
        <button class="btn" id="connectBtn">Connect apps</button>
        <button class="btn" id="sampleBtn" title="Shortcut: ?">Try sample tour</button>
      </div>
    </div>

    <!-- Statusbar (kept minimal) -->
    <div class="statusbar" role="status" aria-live="polite">
      <span class="pill" id="stat-sync">Last sync: never</span>
      <span class="pill" id="stat-mode">Offline-first</span>
    </div>

    <div class="hero">
      <div class="hero-title">Everyday AI</div>
      <!-- subtext removed -->
      <textarea id="inbox" placeholder="Paste subjects, DMs, reminders — one per line."></textarea>
      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn primary" id="buildBtn" title="Organize (⌘/Ctrl+Enter)"><span class="label">Organize</span></button>
        <button class="btn" id="clearBtn">Clear</button>
      </div>
    </div>

    <section class="section priority">
      <h2>Priority Dashboard</h2>
      <div class="lanes">
        <div class="lane"><h3>Act</h3><div id="lane-act"></div></div>
        <div class="lane"><h3>Schedule</h3><div id="lane-schedule"></div></div>
        <div class="lane"><h3>Follow-up</h3><div id="lane-follow"></div></div>
      </div>
    </section>

    <footer class="footer">
      <div>All local, no servers.</div>
      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn" id="openCaps">Memory Capsules</button>
      </div>
    </footer>
  </div>

  <!-- Capsules Modal -->
  <div id="capsuleModal" class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <div class="modal-box">
      <div class="modal-topbar">
        <strong>Memory Capsules</strong>
        <div>
          <button class="btn" id="xCaps">✕</button>
        </div>
      </div>
      <div id="capsules"></div>
      <div class="bar" style="justify-content:flex-end;border-top:1px solid var(--stroke);padding-top:12px">
        <button class="btn success" id="exportCaps">Export JSON</button>
        <button class="btn warning" id="clearCaps">Clear All</button>
        <button class="btn" id="closeCaps">Close</button>
      </div>
    </div>
  </div>

  <!-- Connect Modal -->
  <div id="connectModal" class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <div class="modal-box">
      <div class="modal-topbar">
        <strong>Connect Apps</strong>
        <button class="btn" id="xConnect">✕</button>
      </div>
      <div class="apps" id="apps"></div>
      <div class="bar">
        <button class="btn" id="authBtn">Authenticate Selected</button>
        <button class="btn" id="indexBtn">Import Live Data</button>
        <button class="btn" id="writeBtn">Verify Write-Back</button>
        <span class="meta" id="connMeta">Select one or more apps to begin.</span>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" id="closeConnect">Close</button></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
  /* === Utilities === */
  const $ = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];
  const store = { get(k, f){ try{ const v = localStorage.getItem(k); return v? JSON.parse(v): f; } catch{ return f; } }, set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); } catch{} } };
  function toast(msg, t=2000){ const el=$('#toast'); el.textContent=msg; el.style.opacity='1'; el.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>{el.style.opacity='0'; el.style.display='none';}, t); }
  function nowIso(){ return new Date().toISOString(); }
  const sleep = ms => new Promise(r=>setTimeout(r, ms));
  const BRIDGE_BASES = ['http://127.0.0.1:3535','http://localhost:3535'];
  async function api(path, init) {
    for (const base of BRIDGE_BASES) {
      try { const r = await fetch(base + path, init); if (r.ok) return await r.json(); } catch {}
    }
    throw new Error('ROM Bridge not reachable');
  }

  /* === Memory Capsules === */
  const CAPS_KEY = 'rom_capsules_v1';
  const getCaps = () => store.get(CAPS_KEY, []);
  const setCaps = (list) => store.set(CAPS_KEY, list);
  function addCapsule(c){ const list = getCaps(); list.unshift(c); setCaps(list); }
  function renderCapsules(){
    const list = getCaps();
    const box = $('#capsules');
    if(!list.length){ box.innerHTML = '<div class="meta">No memory yet. Actions you run will be saved here with sources.</div>'; return; }
    box.innerHTML = '';
    list.forEach((c, i)=>{
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `
        <div class="card-header" style="justify-content:space-between;align-items:center">
          <div style="display:flex;gap:10px;align-items:flex-start">
            <span class="prio ${c.prio||'green'}" aria-hidden="true"></span>
            <div>
              <div class="title">${escapeHtml(c.text)}</div>
              <div class="meta-row">
                <span>${(c.cat||'general').toUpperCase()}</span>
                <span>${c.origin||'Manual'}</span>
                <span>${new Date(c.ts).toLocaleString()}</span>
              </div>
            </div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            ${c.href ? `<a class="btn" href="${c.href}" target="_blank" rel="noopener noreferrer">${c.action||'Open'}</a>` : ''}
            <button class="btn" data-restore="${i}">Restore to board</button>
            <button class="btn" data-del="${i}">Delete</button>
          </div>
        </div>
        ${c.note? `<div class="why" style="margin-top:8px">${escapeHtml(c.note)}</div>`:''}
      `;
      el.querySelector('[data-del]')?.addEventListener('click', ()=>{
        const arr = getCaps(); arr.splice(i,1); setCaps(arr); renderCapsules(); toast('Deleted');
      });
      el.querySelector('[data-restore]')?.addEventListener('click', ()=>{
        const arr = getCaps(); const item = arr[i];
        renderCards([item.text]); toast('Restored to board');
      });
      box.appendChild(el);
    });
  }

  // Unified with the Bridge: Gmail, Google Calendar, SMS, WhatsApp, iCal, Slack, Files
  const DEFAULT_CONNECTORS = {
    gmail:   { key:'gmail',   name:'Gmail',            selected:false, status:'not_connected', lastSync:null, records:0, writeReady:false, stages:['not_connected','authed','indexed','write_ready'] },
    google:  { key:'google',  name:'Google Calendar',  selected:false, status:'not_connected', lastSync:null, records:0, writeReady:false, stages:['not_connected','authed','indexed','write_ready'] },
    sms:     { key:'sms',     name:'Phone / SMS',      selected:false, status:'not_connected', lastSync:null, records:0, writeReady:false, stages:['not_connected','indexed','write_ready'] },
    whatsapp:{ key:'whatsapp',name:'WhatsApp',         selected:false, status:'not_connected', lastSync:null, records:0, writeReady:false, stages:['not_connected','indexed','write_ready'] },
    ical:    { key:'ical',    name:'iCalendar (.ics)', selected:false, status:'not_connected', lastSync:null, records:0, writeReady:false, stages:['not_connected','indexed'] },
    slack:   { key:'slack',   name:'Slack',            selected:false, status:'not_connected', lastSync:null, records:0, writeReady:false, stages:['not_connected','authed','indexed','write_ready'] },
    files:   { key:'files',   name:'Local Files',      selected:false, status:'not_connected', lastSync:null, records:0, writeReady:false, stages:['not_connected','indexed'] }
  };
  function mergeConnectors(defaults, saved){
    const out = {};
    // deep clone defaults
    for (const k in defaults) out[k] = { ...defaults[k] };
    // overlay known saved keys
    if (saved && typeof saved === 'object') {
      for (const k in saved) {
        if (out[k]) out[k] = { ...out[k], ...saved[k] };
      }
    }
    return out;
  }

  let CONNECTORS = mergeConnectors(DEFAULT_CONNECTORS, store.get('rom_connectors', null));
  function saveConnectors(){ store.set('rom_connectors', CONNECTORS); }
  saveConnectors(); // write merged shape back so future loads are correct

  function renderConnectors(){
    const box = $('#apps'); box.innerHTML='';
    Object.values(CONNECTORS).forEach(c => {
      const el = document.createElement('div'); el.className='app';
      const chip = statusChip(c.status);
      el.innerHTML = `
        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" ${c.selected? 'checked':''} data-k="${c.key}" aria-label="Select ${c.name}"/>
          <strong>${c.name}</strong>
          <span class="chip ${chip.cls}">${chip.text}</span>
        </label>
        <div class="meta">Last sync: ${c.lastSync? new Date(c.lastSync).toLocaleString(): 'never'} • ${c.records} items</div>
      `;
      el.querySelector('input').addEventListener('change', (e)=>{
        CONNECTORS[c.key].selected = e.target.checked; saveConnectors(); updateConnMeta();
      });
      box.appendChild(el);
    });
    updateConnMeta();
  }
  function statusChip(status){
    switch(status){
      case 'authed': return {text:'Auth’d', cls:'blue chip'};
      case 'indexed': return {text:'Indexed', cls:'purple chip'};
      case 'write_ready': return {text:'Write-back Ready', cls:'green chip'};
      default: return {text:'Not Connected', cls:'gray chip'};
    }
  }
  const anySelected = () => Object.values(CONNECTORS).some(c=>c.selected);
  const anyAuthed = () => Object.values(CONNECTORS).some(c=>c.status!=='not_connected');
  const anyIndexed = () => Object.values(CONNECTORS).some(c=>c.status==='indexed' || c.status==='write_ready');
  function updateConnMeta(){
    const meta=$('#connMeta');
    const parts=[];
    parts.push(Object.values(CONNECTORS).filter(c=>c.status!=='not_connected').length+" app(s) in pipeline");
    if(!anySelected()) parts.push('Select apps');
    $('#authBtn').disabled = !anySelected();
    $('#indexBtn').disabled = !anyAuthed();
    $('#writeBtn').disabled = !anyIndexed();
    meta.textContent = parts.join(' • ');
  }

  /* === Bridge-backed flows === */
  function busy(btn, label){ const old=btn.innerHTML; btn.disabled=true; btn.innerHTML = `<span class="spinner"></span> ${label}`; return ()=>{ btn.disabled=false; btn.innerHTML = old; } }
  function renderConnectors(){
    const box = $('#apps'); box.innerHTML='';
    Object.values(CONNECTORS).forEach(c => {
      const el = document.createElement('div'); el.className='app';
      const chip = statusChip(c.status);
      el.innerHTML = `
        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" ${c.selected? 'checked':''} data-k="${c.key}" aria-label="Select ${c.name}"/>
          <strong>${c.name}</strong>
          <span class="chip ${chip.cls}">${chip.text}</span>
        </label>
        <div class="meta">Last sync: ${c.lastSync? new Date(c.lastSync).toLocaleString(): 'never'} • ${c.records} items</div>
      `;
      el.querySelector('input')?.addEventListener('change', (e)=>{
        CONNECTORS[c.key].selected = e.target.checked; saveConnectors(); updateConnMeta();
      });
      box.appendChild(el);
    });
    updateConnMeta();
  }

  async function authenticateSelected(){
    const end = busy($('#authBtn'), ' Working…');
    try {
      const sel = Object.values(CONNECTORS).filter(c=>c.selected).map(c=>c.key);

      if (sel.includes('slack'))  { await api('/slack/start', {method:'POST'}); CONNECTORS.slack.status='authed'; }
      if (sel.includes('google')) { const r = await api('/google/install'); if (r.url) window.open(r.url,'_blank','noopener,noreferrer'); CONNECTORS.google.status='authed'; }
      if (sel.includes('gmail'))  { const r = await api('/gmail/install');  if (r.url) window.open(r.url,'_blank','noopener,noreferrer'); CONNECTORS.gmail.status='authed'; }

      if (sel.includes('ical')) {
        const icsUrl = prompt('Paste an .ics URL to subscribe (you can add more later):','');
        if (icsUrl) { await api('/ical/subscribe', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ url: icsUrl })}); CONNECTORS.ical.status='indexed'; CONNECTORS.ical.lastSync=nowIso(); }
      }

      if (sel.includes('sms'))      { CONNECTORS.sms.status='indexed'; CONNECTORS.sms.lastSync=nowIso(); }
      if (sel.includes('whatsapp')) { CONNECTORS.whatsapp.status='indexed'; CONNECTORS.whatsapp.lastSync=nowIso(); }
      if (sel.includes('files'))    { CONNECTORS.files.status='indexed'; CONNECTORS.files.lastSync=nowIso(); }

      saveConnectors(); renderConnectors(); toast('Authenticated');
    } catch(e){ toast('Bridge not reachable'); }
    end();
  }

  async function importLiveData(){
    const end = busy($('#indexBtn'), ' Importing…');
    try {
      let total=0;
      if (CONNECTORS.google.status!=='not_connected')  { const r = await api('/google/backfill', {method:'POST'}); total += r?.imported||0; CONNECTORS.google.status='indexed'; CONNECTORS.google.lastSync=nowIso(); }
      if (CONNECTORS.slack.status!=='not_connected')   { const r = await api('/slack/backfill', {method:'POST'});  total += r?.imported||0; CONNECTORS.slack.status='indexed'; CONNECTORS.slack.lastSync=nowIso(); }
      if (CONNECTORS.gmail.status!=='not_connected')   { const r = await api('/gmail/backfill', {method:'POST'});  total += r?.imported||0; CONNECTORS.gmail.status='indexed'; CONNECTORS.gmail.lastSync=nowIso(); }
      if (CONNECTORS.ical.status!=='not_connected')    { const r = await api('/ical/sync',      {method:'POST'});  total += r?.imported||0; CONNECTORS.ical.lastSync=nowIso(); }

      saveConnectors(); renderConnectors();
      $('#stat-sync').textContent = `Last sync: ${new Date().toLocaleTimeString()}`;
      toast(`Imported ${total} items`);
    } catch(e){ toast('Import failed — is the Bridge running?'); }
    end();
  }

  async function verifyWriteBack(){
    const end = busy($('#writeBtn'), ' Verifying…');
    try {
      // Create a 15-minute hold now on Calendar (real write)
      if (CONNECTORS.google.status!=='not_connected'){
        await api('/google/hold', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title:'ROM Hold', whenISO:new Date().toISOString(), durationMin:15 }) });
        CONNECTORS.google.status='write_ready';
      }
      // Mark others as ready if they’re indexed (we’ll add active sends per-source as you configure)
      if (CONNECTORS.slack.status==='indexed')    CONNECTORS.slack.status='write_ready';
      if (CONNECTORS.sms.status==='indexed')      CONNECTORS.sms.status='write_ready';
      if (CONNECTORS.whatsapp.status==='indexed') CONNECTORS.whatsapp.status='write_ready';
      if (CONNECTORS.gmail.status==='indexed')    CONNECTORS.gmail.status='write_ready';

      saveConnectors(); renderConnectors(); toast('Write-back verified');
    } catch(e){ toast('Write-back failed'); }
    end();
  }

  /* === Friendlier “Why” === */
  function friendlyWhy(info){
    const bits=[];
    if(info.when) bits.push(`Time-specific: ${info.when}`);
    if(info.money) bits.push('Worth closing the loop on billing');
    if(info.review) bits.push('Needs your eyes before it moves forward');
    if(info.question) bits.push('Someone’s waiting on an answer');
    if(info.meeting) bits.push('Coordinate on time/place');
    if(!bits.length) return 'Small step now prevents pile-up later';
    return bits.join(' • ');
  }

  /* === Card analysis + lane routing (Act / Schedule / Follow-up) === */
  function analyze(line){
    const lower=line.toLowerCase();
    let cat='general', prio='green';
    const info = { when:null, meeting:false, money:false, review:false, question:false };

    // timing (prio)
    if(/\b(today|now|overdue|asap)\b/.test(lower)){ prio='red'; info.when='today'; }
    else if(/\b(tomorrow|soon|friday|mon(day)?|tue(sday)?|wed(nesday)?|thu(rsday)?|sat(urday)?|sun(day)?|this week)\b/.test(lower)){
      prio='orange'; info.when=(line.match(/\b(tomorrow|soon|this week|friday|monday|tuesday|wednesday|thursday|saturday|sunday)\b/i)||[])[0];
    }

    // domains
    if(/\b(meeting|coffee|call|1:1|standup|lunch|dinner)\b/.test(lower)){ cat='meeting'; info.meeting=true; }
    if(/\b(invoice|payment|pay|bill|budget|finance|overdue)\b/.test(lower)){ if(cat==='general') cat='finance'; info.money=true; }
    if(/\b(review|approve|draft|edit|finalize|submit|feedback)\b/.test(lower)){ if(cat==='general') cat='review'; info.review=true; }
    if(/[?]/.test(line)){ info.question=true; }

    const origin = /gmail|email|re:/.test(lower)? 'Gmail' : /slack/.test(lower)? 'Slack' : /sms|text|imessage|whatsapp/.test(lower)? 'SMS' : 'Manual';
    const why = friendlyWhy(info);

    // lane routing
    const lane = routeLane({cat, prio, info});

    const route = routeAction({origin, cat, text: line});
    return { line, cat, prio, why, origin, route, lane };
  }

  function routeLane({cat, prio, info}){
    // Schedule: meetings and any time-bound planning
    if(cat==='meeting' || info.when && /tomorrow|friday|monday|tuesday|wednesday|thursday|saturday|sunday|this week|soon/i.test(info.when)) return 'schedule';
    // Follow-up: questions or explicit "follow up" strings
    if(info.question || /\bfollow\s?up|waiting on|check back\b/i.test(cat)) return 'follow';
    // Act: urgent/overdue/finance/review/now
    if(prio==='red' || cat==='finance' || cat==='review') return 'act';
    // default: act (to avoid empty columns)
    return 'act';
  }

  function nextStep(cat){
    switch(cat){
      case 'meeting': return 'Confirm time and add a hold to calendar';
      case 'finance': return 'Open invoice app and pay / follow up';
      case 'review': return 'Open the doc, review, then send a quick note';
      default: return 'Take the next concrete step';
    }
  }

  function routeAction({origin, cat, text}){
    const enc = encodeURIComponent(text.replace(/^re:\s*/i,''));
    const reply = proposeReply(text);
    if(origin==='SMS')   return { label:'Reply in Messages', href:`sms:&body=${encodeURIComponent(reply)}` };
    if(origin==='Slack') return { label:'Open in Slack', href:'slack://open' };
    if(origin==='Gmail') return { label:'Draft in Gmail', href:`https://mail.google.com/mail/?view=cm&su=${enc}&body=${encodeURIComponent(reply)}` };
    if(cat==='meeting')  return { label:'Add to Google Calendar', href:`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${enc}&details=${enc}` };
    if(cat==='finance')  return { label:'Open Invoice App', href:'https://app.qbo.intuit.com/app/homepage' };
    return { label:'Copy reply', href:'#copy', payload:reply };
  }

  function proposeReply(text){
    const t=text.toLowerCase();
    if(/coffee|meet|lunch|dinner|call/.test(t)) return 'Sounds good — see you then. If anything changes, text me.';
    if(/review|draft|feedback|approve|look/.test(t)) return 'Got it — I’ll review now and follow up shortly.';
    if(/invoice|payment|overdue|bill/.test(t)) return 'Thanks — I’ll take care of the invoice and confirm once paid.';
    if(/[?]/.test(t)) return 'Thanks for the question — I’ll check and get back shortly.';
    return 'Noted — on it.';
  }

  function renderCards(lines){
    const L = { act: $('#lane-act'), schedule: $('#lane-schedule'), follow: $('#lane-follow') };
    Object.values(L).forEach(el=> el.innerHTML='');
    const items = lines.map(analyze);
    items.forEach((it)=>{
      const card=document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="card-header">
          <span class="prio ${it.prio}"></span>
          <div class="title">${escapeHtml(it.line)}</div>
        </div>
        <div class="meta-row">
          <span>${it.cat.toUpperCase()}</span>
          <span>${it.origin}</span>
          <details class="rationale"><summary>Why this surfaced</summary><div class="why">${escapeHtml(it.why)}</div></details>
        </div>
        <div class="card-actions">
          <button class="btn primary action-btn"><span class="label">Next Step</span></button>
        </div>`;
      card.querySelector('.action-btn').addEventListener('click', (e)=> runAction(e.currentTarget, it));
      (L[it.lane] || L.act).appendChild(card);
    });
  }

  function escapeHtml(s){ return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

  async function runAction(btn, item){
    const end = buttonBusy(btn);
    await sleep(150);
    const { route } = item;

    if(route.href==='#copy'){
      try{ await navigator.clipboard.writeText(route.payload||''); toast('Reply copied'); }
      catch{ toast('Copy failed'); }
    } else {
      window.open(route.href, '_blank', 'noopener,noreferrer');
      toast('Opened');
    }

    // Memory capsule
    addCapsule({
      ts: nowIso(),
      text: item.line,
      cat: item.cat,
      origin: item.origin,
      prio: item.prio,
      action: route.label,
      href: route.href && route.href !== '#copy' ? route.href : null,
      note: item.why
    });

    end('Done');
  }

  function buttonBusy(btn){
    const label=btn.querySelector('.label'); const old=label.textContent;
    btn.disabled=true; label.textContent='Working…';
    let sp=document.createElement('span'); sp.className='spinner'; btn.prepend(sp);
    return (done='Done')=>{
      btn.disabled=false; label.textContent=done;
      setTimeout(()=> label.textContent=old, 900); sp.remove();
    }
  }

  /* Capsules modal controls */
  function openCapsules(){ renderCapsules(); $('#capsuleModal').setAttribute('open',''); }

  /* Sample */
  const SAMPLE = [
    'Coffee with Alex tomorrow 10am (text)',
    'Invoice #1187 overdue 7 days — ACME',
    'Draft product page review before Friday (Notion?)',
    'Can you send the deck by EOD?'
  ];

  document.addEventListener('DOMContentLoaded', ()=>{
    $('#buildBtn').addEventListener('click', ()=>{
      const raw = $('#inbox').value.trim().split(/\n/).filter(Boolean);
      if(!raw.length) return toast('Paste something first');
      renderCards(raw); toast(`Organized ${raw.length} item${raw.length>1?'s':''}`);
    });
    $('#clearBtn').addEventListener('click', ()=> $('#inbox').value='');
    $('#sampleBtn').addEventListener('click', ()=>{ $('#inbox').value = SAMPLE.join('\n'); toast('Loaded a guided sample. Press Organize.'); });

    // Capsules modal
    $('#openCaps').addEventListener('click', openCapsules);
    $('#xCaps').addEventListener('click', ()=> $('#capsuleModal').removeAttribute('open'));
    $('#closeCaps').addEventListener('click', ()=> $('#capsuleModal').removeAttribute('open'));
    $('#clearCaps').addEventListener('click', ()=>{ if(confirm('Clear all capsules?')){ setCaps([]); renderCapsules(); toast('Cleared'); } });
    $('#exportCaps').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({capsules:getCaps()},null,2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rom-capsules.json'; a.click(); toast('Exported');
    });

    // Connect modal
    $('#connectBtn').addEventListener('click', ()=>{ renderConnectors(); $('#connectModal').setAttribute('open',''); });
    $('#xConnect').addEventListener('click', ()=> $('#connectModal').removeAttribute('open'));
    $('#closeConnect').addEventListener('click', ()=> $('#connectModal').removeAttribute('open'));
    $('#authBtn').addEventListener('click', authenticateSelected);
    $('#indexBtn').addEventListener('click', importLiveData);
    $('#writeBtn').addEventListener('click', verifyWriteBack);

    // Statusbar init
    $('#stat-sync').textContent = `Last sync: never`;
  });
  </script>
</body>
</html>
